user_v12');

        if (u) { showMain(); }

    };


    async function recuperaStatus(nome) {

        try {

            const r = await fetch(SCRIPT_URL + '?nome=' + encodeURIComponent(nome) + '&t=' + Date.now());

            const data = await r.json();

            document.getElementById('statusDisplay').innerText = data.status || "Nessun messaggio. Chiedici pure se abbiamo posto!";

        } catch(e) { document.getElementById('statusDisplay').innerText = "Benvenuti in famiglia! üêæ"; }

    }


    async function loadOccupiedDates() {

        try {

            const r = await fetch(SPREADSHEET_CSV + "&t=" + Date.now());

            const text = await r.text();

            const rows = text.split(/\r?\n/);

            occupiedDates = [];

            rows.forEach(row => {

                const cols = row.split(',');

                if (cols.length >= 2) {

                    const dC = cols[0].trim().replace(/"/g, '');

                    if (cols[1].trim().replace(/"/g, '') === "1") {

                        const p = dC.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);

                        if (p) occupiedDates.push(`${parseInt(p[1])}/${parseInt(p[2])}/${p[3]}`);

                    }

                }

            });

            renderCalendar();

        } catch(e) {}

    }


    function renderCalendar() {

        const grid = document.getElementById('calendarGrid');

        const m = currentViewDate.getMonth();

        const y = currentViewDate.getFullYear();

        document.getElementById('monthTitle').innerText = currentViewDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });

        grid.innerHTML = "";

        ['Lu', 'Ma', 'Me', 'Gi', 'Ve', 'Sa', 'Do'].forEach(d => grid.innerHTML += `<div class="day-label">${d}</div>`);

        const first = new Date(y, m, 1).getDay();

        const days = new Date(y, m + 1, 0).getDate();

        let shift = (first === 0) ? 6 : first - 1;

        for(let i=0; i<shift; i++) grid.innerHTML += `<div></div>`;

        for(let d=1; d<=days; d++) {

            const dateKey = `${d}/${m + 1}/${y}`;

            const displayDate = `${d.toString().padStart(2,'0')}/${(m+1).toString().padStart(2,'0')}/${y}`;

            const isOcc = occupiedDates.includes(dateKey);

            const isSel = selectedDates.includes(displayDate);

            const cell = document.createElement('div');

            cell.className = `cell ${isOcc ? 'occupied' : ''} ${isSel ? 'selected' : ''}`;

            cell.innerText = d;

            if(!isOcc) {

                cell.onclick = () => {

                    if(selectedDates.includes(displayDate)) selectedDates = selectedDates.filter(s => s !== displayDate);

                    else selectedDates.push(displayDate);

                    renderCalendar();

                };

            }

            grid.appendChild(cell);

        }

    }


    function changeMonth(dir) { currentViewDate.setMonth(currentViewDate.getMonth() + dir); renderCalendar(); }


    function sendWA() {

        const u = JSON.parse(localStorage.getItem('fd_user_v12'));

        if(selectedDates.length === 0) return alert("Scegli le date!");

        const lista = selectedDates.sort().join(', ');

        const msg = `Ciao Davide e Maria! Sono ${u.nome}. Vorrei chiedervi la disponibilit√† per ${u.cane} per questi giorni: ${lista} üêæ`;

        window.open(`https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`);

    }

</script>

</body>

</html> 
