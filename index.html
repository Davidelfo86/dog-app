<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Familydog Home üêæ</title>

<style>
body{margin:0;font-family:sans-serif;background:#37474f;display:flex;justify-content:center}
.app{max-width:430px;width:100%;background:#e1f5fe;min-height:100vh;padding:15px;box-sizing:border-box}
.hidden{display:none}
input,select,textarea,button{width:100%;padding:10px;margin:5px 0;border-radius:10px;border:1px solid #ccc;box-sizing:border-box}
button{background:#4fc3f7;color:#fff;border:none;font-weight:bold;cursor:pointer}
.cell{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:13px}
.occupied{background:#ffcdd2;text-decoration:line-through;cursor:default}
.selected{background:#4fc3f7;color:#fff}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}
.badge{color:#ff9800;font-weight:bold;margin:10px 0}
.admin-mode .user-only{display:none}
.note{font-size:10px;margin-top:3px}
.section{background:#fff;border-radius:15px;padding:12px;margin:10px 0}
</style>
</head>
<body>

<div class="app">

<!-- REGISTRAZIONE -->
<div id="reg">
<h2>Familydog Home üêæ</h2>
<input id="uName" placeholder="Tuo nome">
<input id="dName" placeholder="Nome cane">
<input id="secretCode" placeholder="Codice famiglia">
<button id="enterBtn">Entra</button>
</div>

<!-- MAIN -->
<div id="main" class="hidden">

<h3 id="welcome"></h3>
<div id="badge" class="badge hidden"></div>

<div class="section">
<h4>Diario</h4>
<div id="status">Caricamento...</div>
</div>

<div class="section">
<div style="display:flex;justify-content:space-between;align-items:center">
<button id="prev">‚Äπ</button>
<div id="month"></div>
<button id="next">‚Ä∫</button>
</div>
<div class="grid" id="calendar"></div>
</div>

<div id="adminEvents" class="section hidden">
<h4>Eventi Speciali</h4>
<div id="firstMeet"></div>
<div id="trialDay"></div>
</div>

<button id="waBtn" class="user-only">Chiedi disponibilit√†</button>
<button id="logout">Esci</button>
<button id="deleteProfile" class="user-only" style="background:#ef5350">Cancella profilo</button>

</div>
</div>

<script>
/* ================= CONFIG ================= */

const CONFIG={
CALENDAR_CSV:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTyoiqz94Cvk9EQHjdds2HjWsm287fPOwmnk8SgxStOtuii2MPyIcU8DF2Zc6YminBxVws8jEJEyaQz/pub?gid=0&single=true&output=csv",
UTENTI_CSV:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTBdxqXOljCTBZjSf-uF0Y7UEydpGeC6bPU4P8uMCDdscKfNsT4ZRkBNp5P7CnfK07xpj2fb-vTfVN0/pub?output=csv",
SCRIPT_URL:"https://script.google.com/macros/s/AKfycbwSGOHNMnhlDgdNVuuZfWYHQ279NN-Y6Qdl756Oj5w84wggrorVz4tirXeeTsEBbCGg/exec",
PHONE:"393299456267",
SECRET_CODE:"bau123",
OWNER_CODE:"davideeluna"
};

/* ================= STATE ================= */

let state={
user:null,
owner:false,
occupied:new Set(),
selected:new Set(),
notes:{},
firstMeet:[],
trialDay:[],
viewDate:new Date()
};

const $=id=>document.getElementById(id);
const normalize=s=>(s||"").toLowerCase().trim();

/* ================= INIT ================= */

window.onload=()=>{
const saved=localStorage.getItem("fd_user_v2");
if(saved){
state.user=JSON.parse(saved);
state.owner=state.user.role==="owner";
showMain();
}
};

$("enterBtn").onclick=register;

/* ================= REGISTRA ================= */

function register(){
const nome=$("uName").value.trim();
const cane=$("dName").value.trim();
const code=normalize($("secretCode").value);

if(!nome||!cane)return alert("Compila nome e cane");

if(code===CONFIG.OWNER_CODE){
state.user={nome:"Davide",cane:"Luna",role:"owner"};
state.owner=true;
}else if(code===CONFIG.SECRET_CODE){
state.user={nome,cane,role:"user"};
}else return alert("Codice errato");

localStorage.setItem("fd_user_v2",JSON.stringify(state.user));
showMain();
}

/* ================= MAIN ================= */

function showMain(){
$("reg").classList.add("hidden");
$("main").classList.remove("hidden");

if(state.owner){
document.body.classList.add("admin-mode");
$("welcome").textContent="Modalit√† Gestione üëë";
$("adminEvents").classList.remove("hidden");
}else{
$("welcome").textContent=`Ciao ${state.user.nome} e ${state.user.cane}!`;
loadBadge();
fetchStatus();
}

loadCalendar();
}

/* ================= BADGE ================= */

async function loadBadge(){
try{
const res=await fetch(CONFIG.UTENTI_CSV+"?t="+Date.now());
const rows=(await res.text()).split(/\r?\n/).map(r=>r.split(","));
for(let i=1;i<rows.length;i++){
if(normalize(rows[i][0])===normalize(state.user.nome)){
const last=rows[i].filter(c=>c.trim()!=="").pop();
const map={
"incontro":"üè† Primo incontro",
"inserito":"üç≤ Inserito",
"amico":"‚ù§Ô∏è Amico affezionato",
"veterano":"üëë Veterano",
"famiglia":"üè° Parte della famiglia"
};
if(map[normalize(last)]){
$("badge").textContent=map[normalize(last)];
$("badge").classList.remove("hidden");
}
break;
}
}
}catch{}
}

/* ================= STATUS ================= */

async function fetchStatus(){
try{
const res=await fetch(`${CONFIG.SCRIPT_URL}?nome=${encodeURIComponent(state.user.nome)}`);
const data=await res.json();
$("status").textContent=data.status||"Nessun messaggio.";
}catch{
$("status").textContent="Benvenuti!";
}
}

/* ================= CALENDARIO ================= */

async function loadCalendar(){
try{
const res=await fetch(CONFIG.CALENDAR_CSV+"&t="+Date.now());
const rows=(await res.text()).split(/\r?\n/).map(r=>r.split(","));

state.occupied.clear();
state.notes={};
state.firstMeet=[];
state.trialDay=[];

rows.slice(1).forEach(r=>{
const match=r[0]?.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
if(!match)return;
const iso=`${match[3]}-${match[2].padStart(2,"0")}-${match[1].padStart(2,"0")}`;

if(normalize(r[1])==="1")state.occupied.add(iso);
if(r[2])state.notes[iso]=r[2];
if(r[3])state.firstMeet.push({date:iso,text:r[3]});
if(r[4])state.trialDay.push({date:iso,text:r[4]});
});

renderCalendar();
renderAdminEvents();

}catch(e){console.error(e);}
}

function renderCalendar(){
const grid=$("calendar");
grid.innerHTML="";
const y=state.viewDate.getFullYear();
const m=state.viewDate.getMonth();
const days=new Date(y,m+1,0).getDate();
const first=(new Date(y,m,1).getDay()+6)%7;
$("month").textContent=state.viewDate.toLocaleDateString("it-IT",{month:"long",year:"numeric"});

for(let i=0;i<first;i++)grid.innerHTML+="<div></div>";

for(let d=1;d<=days;d++){
const iso=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
const div=document.createElement("div");
div.className="cell";
div.textContent=d;

if(state.occupied.has(iso))div.classList.add("occupied");
if(state.selected.has(iso))div.classList.add("selected");

if(state.owner && state.notes[iso]){
const note=document.createElement("div");
note.className="note";
note.textContent=state.notes[iso];
div.appendChild(note);
}

if(!state.owner && !state.occupied.has(iso)){
div.onclick=()=>{
state.selected.has(iso)?state.selected.delete(iso):state.selected.add(iso);
renderCalendar();
};
}

grid.appendChild(div);
}
}

/* ================= EVENTI ADMIN ================= */

function renderAdminEvents(){
if(!state.owner)return;
$("firstMeet").innerHTML="<strong>Primo incontro</strong><br>"+
(state.firstMeet.length?state.firstMeet.map(e=>e.date+" - "+e.text).join("<br>"):"Nessuno");
$("trialDay").innerHTML="<br><strong>Giornata prova</strong><br>"+
(state.trialDay.length?state.trialDay.map(e=>e.date+" - "+e.text).join("<br>"):"Nessuna");
}

/* ================= NAV ================= */

$("prev").onclick=()=>{state.viewDate.setMonth(state.viewDate.getMonth()-1);renderCalendar();}
$("next").onclick=()=>{state.viewDate.setMonth(state.viewDate.getMonth()+1);renderCalendar();}

/* ================= WHATSAPP ================= */

$("waBtn").onclick=()=>{
if(!state.selected.size)return alert("Seleziona date");
const dates=[...state.selected].sort().join(", ");
const msg=`Ciao! Sono ${state.user.nome}, info per ${state.user.cane} per: ${dates}`;
window.open(`https://wa.me/${CONFIG.PHONE}?text=${encodeURIComponent(msg)}`);
};

/* ================= LOGOUT ================= */

$("logout").onclick=()=>{
localStorage.removeItem("fd_user_v2");
location.reload();
};

$("deleteProfile").onclick=()=>{
if(confirm("Cancellare profilo?")){
localStorage.removeItem("fd_user_v2");
location.reload();
}
};
</script>

</body>
</html>
